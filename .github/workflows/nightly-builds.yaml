name: Nightly Build and Test

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  packages: write
  contents: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required to fetch all tags for git describe

      - name: Semantic Release
        id: version
        if: github.ref == 'refs/heads/main' && hashFiles('package.json') != ''
        uses: cycjimmy/semantic-release-action@v4
        with:
          extra_plugins: |
            @semantic-release/commit-analyzer
            @semantic-release/release-notes-generator
            @semantic-release/github
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tag
        id: tag
        if: steps.version.outputs.new_release_published == 'true'
        run: echo "version=${{ steps.version.outputs.new_release_version }}" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest
          pip install aiosqlite
      - name: Run Tests
        id: run-tests
        env:
          # Hardcoded CI values to avoid missing GitHub secrets
          DATABASE_URL: sqlite+aiosqlite:///./test.db
          JWT_SECRET: ci-test-secret
          JWT_ALGORITHM: HS256
          MAIL_USERNAME: ci@example.com
          MAIL_PASSWORD: ci-password
          MAIL_SERVER: smtp.ethereal.email
          MAIL_PORT: "587"
          MAIL_FROM: ci@example.com
          MAIL_FROM_NAME: CI Bot
          DOMAIN: http://localhost:8000
          REDIS_URL: redis://localhost:6379/0
        run: python -m pytest src/tests 2>&1 | tee /tmp/pytest_output.txt; exit ${PIPESTATUS[0]}

      - name: Capture latest commit author email
        if: steps.run-tests.outcome == 'failure'
        run: |
          AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          echo "author_email=$AUTHOR_EMAIL" >> "$GITHUB_ENV"

      - name: Send email on test failure
        if: steps.run-tests.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.ethereal.email
          server_port: 587
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "Nightly Build Failed: Test Failure"
          to: ${{ env.author_email }}
          from: GitHub Actions
          body: |
            The nightly build failed due to test errors.
            See this run for logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      - name: Login to Container Registry
        if: steps.version.outputs.new_release_published == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        if: steps.version.outputs.new_release_published == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/fastapi-beyond-crud:${{ steps.tag.outputs.version }}